<template>
	<Layout v-bind="{
      currentPage: 'Profile',
      pageOptions: mobileHeaderUiOptions
    }">
		<v-layout id="createIdeaPage">

			<div class="createIdeaBox">
				<!-- Header -->
				<v-layout class="headerText" hidden-sm-and-down>
					<v-row>
						<v-col>MY IDEA
						</v-col>
						<v-col class="privateIcon">
							<img alt="image" src="~/assets/images/publicIdea.png" />
						</v-col>
					</v-row>
				</v-layout>

				<!-- title -->
				<v-textarea v-model="title" v-validate="'required|max:100'" :error-messages="errors.collect('title')" data-vv-name="title" outlined label="Type your idea Title">
				</v-textarea>

				<!-- Descriptiion = trix editor -->
				<div class="ideaEditor">
					<VueTrix v-model="contents" :class="{'errorBox': errorMsg }" placeholder="Type your idea description" class="trixEditor" />
					<div v-if="!contents" class="trixErrorMsg">
						{{ errorMsg }}
					</div>
				</div>

				<!-- Tags -->
				<v-combobox v-model="chips" v-validate="'required|max:100'" :error-messages="errors.collect('tag')" data-vv-name="tag" class="ideaTag" :items="items" chips clearable multiple outlined label="Add Tags">
					<template v-slot:selection="{ attrs, item, select, selected }">
						<v-chip v-bind="attrs" :input-value="selected" close label @click="select" @click:close="remove(item)">
							<strong>{{ item }}</strong>
						</v-chip>
					</template>
				</v-combobox>

				<!-- Submit -->
				<div class="submitBtn">
					<v-btn :loading="creatingIdea" @click="onCreateIdea">Submit</v-btn>
				</div>

			</div>

			<!-- Bottom snackbar message -->
			<v-snackbar v-model="snackbarVisible" :timeout="2000" :color="snackbarColor">
				{{ snackbarMessage }}
				<v-btn color="white" text @click="snackbarVisible = false">
					Close
				</v-btn>
			</v-snackbar>
		</v-layout>
	</Layout>
</template>
<script>
import { graphqlOperation } from '@aws-amplify/api'
import Layout from '@/components/layout/Layout'
import createIdea from '~/graphql/mutations/createIdea'

export default {
	components: { Layout },
	$_veeValidate: {
		validator: 'new'
	},
	data: () => ({
		mobileHeaderUiOptions: {
			pageTitle: "Bob's Profile",
			leftButtonType: 'back'
		},
		contents: '',
		title: '',
		creatingIdea: false,
		chips: [],
		// sjahj: true,
		errorMsg: null,

		snackbarVisible: false,
		snackbarMessage: '',
		snackbarColor: 'success'
	}),
	created() {},
	mounted() {},
	methods: {
		remove(item) {
			this.chips.splice(this.chips.indexOf(item), 1)
			this.chips = [...this.chips]
		},
		async onCreateIdea() {
			let result = await this.$validator.validateAll()
			if (!result) {
				this.errorMsg = 'This field is required.'
				return
			}

			this.creatingIdea = true

			try {
				let result = await this.$amplifyApi.graphql(
					graphqlOperation(createIdea, {
						content: this.contents,
						title: this.title
					})
				)

				this.creatingIdea = false
				this.ideaEditorVisible = false

				this.snackbarMessage = 'Idea Created'
				this.snackbarColor = 'success'
				this.snackbarVisible = true

				// Redirect to idea deail page
				let ideaId = result.data.createIdea.ideaId
				this.$router.push({
					name: 'ideas-userId-ideaId',
					params: { ideaId, userId: this.$store.getters['cognito/userSub'] },
					force: true
				})
			} catch (err) {
				this.creatingIdea = false
				this.snackbarMessage = 'Something went wrong!!'
				this.snackbarColor = 'error'
				this.snackbarVisible = true
				// console.error(err)
			}
		}
	}
}
</script>

<style lang="scss">
#createIdeaPage {
	background: white;
	min-height: 94vh;
	width: 100%;
	overflow-x: hidden;

	.createIdeaBox {
		width: 100%;
		max-width: 750px;
		margin-left: auto;
		margin-right: auto;
		margin-top: 4vh;

		@media #{$small-screen} {
			width: 90%;

			// fieldset {
			// 	border: none !important;
			// }
		}

		.headerText {
			font-size: 16px;

			.privateIcon {
				text-align: right;
			}
		}

		.ideaEditor {
			margin-top: 3vh;
			font-size: 14px;

			@media #{$small-screen} {
				font-size: 8px;
			}

			.trixEditor {
				.trix-content {
					height: 170px !important;
					max-height: 200px !important;
					overflow-y: auto;
					@media #{$small-screen} {
						border: none !important;
					}
				}
				trix-editor:empty:not(:focus)::before {
					color: #9c9c9c;
					font-size: 16px;
				}
			}
			.trixEditor.errorBox {
				.trix-content {
					border: 2px solid #b71c1c;
				}
				trix-editor:empty:not(:focus)::before {
					color: #b71c1c;
				}
			}

			.trixErrorMsg {
				color: #b71c1c;
				font-size: 12px;
				margin-top: 5px;
				padding-left: 10px;
			}
		}

		.ideaTag {
			padding-top: 30px;

			.v-chip {
				background-color: rgba(192, 183, 197);
				color: white;

				i {
					color: white;
				}
			}

			.v-icon.mdi-menu-down {
				display: none;
			}

			.v-input__append-inner {
				display: none;
			}
		}

		.submitBtn {
			margin-top: 5vh;

			button {
				width: 100%;
				height: 50px;
				margin: 0px;
			}
		}
	}
}
</style>
